# VPS解锁监控 - 快速使用指南

## 🎯 核心流程

```
VPS (Nezha定时任务) → 检测脚本 → 上报数据 → 中心服务器 → Web可视化
```

## 📋 部署步骤

### 第一步：启动中心服务器

在你的监控服务器上：

```bash
cd /Users/tp/vpsMonitor
pip install -r requirements.txt
python app.py
```

记下服务器地址，例如：`http://123.45.67.89:5000`

### 第二步：部署到VPS

#### 自动部署（推荐）

```bash
./deploy.sh
```

输入中心服务器地址和VPS信息，脚本会自动完成。

#### 手动部署

1. 上传脚本到VPS：

```bash
scp vps_check.py root@your-vps.com:/root/
```

2. 在Nezha面板添加定时任务：

进入 Nezha 面板 → 选择对应VPS → 添加定时任务

**任务名称**：流媒体解锁检测

**执行命令**：

```bash
export MONITOR_SERVER="http://123.45.67.89:5000" && export VPS_NAME="美国VPS" && python3 /root/vps_check.py
```

**Cron表达式**：`0 */1 * * *` (每小时执行一次)

或：`*/30 * * * *` (每30分钟执行一次)

### 第三步：查看监控面板

浏览器访问：`http://123.45.67.89:5000`

## 🔧 配置示例

### 多台VPS配置

在Nezha面板为每台VPS分别配置：

**VPS-1 (美国)**
```bash
export MONITOR_SERVER="http://123.45.67.89:5000" && export VPS_NAME="美国VPS" && python3 /root/vps_check.py
```

**VPS-2 (日本)**
```bash
export MONITOR_SERVER="http://123.45.67.89:5000" && export VPS_NAME="日本VPS" && python3 /root/vps_check.py
```

**VPS-3 (新加坡)**
```bash
export MONITOR_SERVER="http://123.45.67.89:5000" && export VPS_NAME="新加坡VPS" && python3 /root/vps_check.py
```

## ✅ 验证部署

### 1. 测试VPS脚本

SSH登录到VPS，手动运行：

```bash
export MONITOR_SERVER="http://123.45.67.89:5000"
export VPS_NAME="测试VPS"
python3 /root/vps_check.py
```

应该看到类似输出：

```json
{
  "name": "测试VPS",
  "timestamp": "2025-12-16T10:30:00",
  "streaming": {
    "netflix": {"status": "unlocked", "code": "200"}
  },
  "ai": {
    "chatgpt": {"status": "unlocked", "code": "200"}
  }
}
✓ 数据已上报到 http://123.45.67.89:5000
```

### 2. 检查中心服务器

查看服务器日志：

```bash
tail -f server.log
```

应该看到：

```
✓ 收到 测试VPS 的数据上报
```

### 3. 查看Web界面

访问 `http://123.45.67.89:5000`，应该能看到VPS数据卡片。

## 🎨 自定义检测服务

编辑 `vps_check.py`，修改 `SERVICES` 字典：

```python
SERVICES = {
    'streaming': {
        'netflix': 'https://www.netflix.com',
        'disney': 'https://www.disneyplus.com',
        'youtube': 'https://www.youtube.com/premium',
        'tiktok': 'https://www.tiktok.com',  # 新增
    },
    'ai': {
        'chatgpt': 'https://chat.openai.com',
        'claude': 'https://claude.ai',
        'gemini': 'https://gemini.google.com',
        'poe': 'https://poe.com',  # 新增
    }
}
```

重新上传到所有VPS即可。

## 🐛 常见问题

### Q: VPS无法上报数据？

**A:** 检查以下几点：

1. 中心服务器防火墙是否开放端口：
   ```bash
   ufw allow 5000
   ```

2. VPS能否访问中心服务器：
   ```bash
   curl http://123.45.67.89:5000/api/latest
   ```

3. 检查Nezha任务执行日志

### Q: Web界面没有数据？

**A:** 

1. 检查 `results/latest.json` 是否存在
2. 手动在VPS上运行一次脚本
3. 刷新浏览器页面

### Q: 如何修改检测频率？

**A:** 在Nezha面板修改Cron表达式：

- 每30分钟：`*/30 * * * *`
- 每小时：`0 */1 * * *`
- 每2小时：`0 */2 * * *`

### Q: 如何后台运行中心服务器？

**A:** 使用 nohup 或 screen：

```bash
# 方式1：nohup
nohup python app.py > server.log 2>&1 &

# 方式2：screen
screen -S vps-monitor
python app.py
# 按 Ctrl+A+D 退出
```

## 📊 监控面板说明

- **绿色 (unlocked)**：服务可正常访问
- **红色 (locked)**：服务被限制访问
- **黄色 (error)**：检测超时或网络错误

数据每5分钟自动刷新，也可点击"刷新数据"按钮手动刷新。

## 🚀 进阶使用

### 添加更多检测项

编辑 `vps_check.py`，在 `SERVICES` 中添加任何你想检测的URL。

### 查看历史数据

历史记录保存在 `results/result_*.json` 文件中，可以自行分析或可视化。

### API接口

- `GET /api/latest` - 获取最新数据
- `POST /api/report` - VPS上报数据（内部使用）

---

**完成！** 现在你可以实时监控所有VPS的解锁状态了 🎉

